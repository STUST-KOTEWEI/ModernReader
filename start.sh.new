#!/bin/bash

# ModernReader å¿«é€Ÿå•Ÿå‹•è…³æœ¬ï¼ˆæœ¬åœ°é–‹ç™¼ï¼‰

set -e

echo "ðŸš€ ModernReader å¿«é€Ÿå•Ÿå‹•"
echo "=========================="
echo ""

# æª¢æŸ¥æ˜¯å¦åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„
if [ ! -f "docker-compose.yml" ]; then
    echo "âŒ è«‹åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œæ­¤è…³æœ¬"
    exit 1
fi

# é¡è‰²å®šç¾©
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 1. å•Ÿå‹•å¾Œç«¯
echo -e "${BLUE}1ï¸âƒ£  å•Ÿå‹•å¾Œç«¯ (http://localhost:8000)...${NC}"
cd backend

# æª¢æŸ¥è™›æ“¬ç’°å¢ƒ
if [ -d ".venv" ]; then
    source .venv/bin/activate
else
    echo "   æ­£åœ¨å‰µå»ºè™›æ“¬ç’°å¢ƒ..."
    poetry install
    source $(poetry env info --path)/bin/activate
fi

# å•Ÿå‹• uvicorn (èƒŒæ™¯åŸ·è¡Œ)
poetry run uvicorn app.main:app --reload --port 8000 > /tmp/modernreader-backend.log 2>&1 &
BACKEND_PID=$!
echo "   å¾Œç«¯ PID: $BACKEND_PID"

cd ..

# ç­‰å¾…å¾Œç«¯å•Ÿå‹•
echo "   ç­‰å¾…å¾Œç«¯å•Ÿå‹•..."
sleep 5

# æª¢æŸ¥å¾Œç«¯æ˜¯å¦æˆåŠŸå•Ÿå‹•
if curl -s http://localhost:8000/docs > /dev/null; then
    echo -e "   ${GREEN}âœ… å¾Œç«¯å•Ÿå‹•æˆåŠŸ${NC}"
else
    echo -e "   ${YELLOW}âš ï¸  å¾Œç«¯å¯èƒ½å•Ÿå‹•å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ: tail -f /tmp/modernreader-backend.log${NC}"
fi

echo ""

# 2. å•Ÿå‹•å‰ç«¯
echo -e "${BLUE}2ï¸âƒ£  å•Ÿå‹•å‰ç«¯ (http://localhost:5173)...${NC}"
cd frontend

# ç¢ºä¿ä½¿ç”¨æœ¬åœ°å¾Œç«¯
cat > .env.local << EOF
VITE_API_BASE_URL=http://localhost:8000/api/v1
