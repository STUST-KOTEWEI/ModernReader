# ModernReader 最終版藍圖 / ModernReader Final Blueprint

## 最近進展 Prototype Highlights
- 完成 FastAPI + SQLAlchemy 永續化層，支援使用者、書籍、閱讀會話、推薦事件、CARE 同意紀錄。
- `scripts/seed_catalog.py` 將 `data/catalogs/sample_books.json` 匯入，形成多來源（ELAR、National Library…）語料庫，可供 Metasearch 與推薦使用。
- 混合式推薦引擎整合語言目標、情緒訊號、文化主題與獎項標記；推薦紀錄寫回資料庫。
- Session API 會自動建立閱讀會話並記錄情緒事件，供後續 RAG 與感官輸出調節。
- Web Dashboard 已加入 Catalog Metasearch（Vite + React）與推薦面板，直接讀取後端資料。
- Apple Swift Package 持續維護，可在 Xcode 中直接引入，同步與後端服務溝通。
- 新增電子紙內容格式化與發佈流程（Web 預覽、EPaper API、裝置佇列），以及 RAG / STT / TTS 集成骨架供後續串接。

> 以下章節保留完整研究與產品藍圖（與先前版本一致），並標註哪些 Components 已進入原型階段。

## 1. 平台願景與硬體範疇 Vision & Device Scope
- **中文**：ModernReader 聚焦於 iPad、iPhone、MacBook Air（macOS）、Apple Watch 等 Apple 裝置，打造符合 CARE 原則的多感官 AI 伴讀體驗，支援低資源與少數民族語言復振。平台整合擴增實境、情感語音、Apple 原生觸覺與穿戴裝置，並由社群共治資料治理。
- **English**: ModernReader leverages Apple hardware (iPad, iPhone, MacBook Air, Apple Watch) to deliver a CARE-aligned multisensory AI reading companion for minority and endangered languages, blending AR, expressive speech, native haptics, and wearable feedback under community-driven governance.

## 2. 系統總體架構 System Architecture Overview
```
+--------------------+        +----------------------------+
|  Apple Clients     |        |  FastAPI Backend           |
|  (SwiftUI, multi-  |        |  Auth, Catalog, RAG,       |
|  platform)         |<-----> |  Recommendation, Sessions  |
+--------------------+        +------------+---------------+
         ^                                 |
         |                                 v
+--------------------+        +----------------------------+
|  Device Services   |        |  Data & Model Platform     |
|  (Core Haptics,    |        |  CARE-governed corpus,     |
|  WatchKit, ARKit)  |        |  LoRA adapters, analytics  |
+--------------------+        +----------------------------+
```
- **Clients**: SwiftUI app shared程式碼，分別針對 iPad/iPhone (ARKit、Vision)、macOS (Catalyst)、watchOS (情緒提示與快取閱讀任務)。
- **Backend**: FastAPI 服務（已在 `backend` 實作原型），提供 JWT 身分驗證、圖書館聯邦搜尋、推書、情緒事件處理與多感官指令端點。
- **Data/Models**: `data/` 管理語料蒐集、資料增強、LoRA 微調及評估；`ops/` 管理部署與 CARE 稽核。

## 3. 功能模組 Functional Modules
| 模組 Module | 功能 Functions | Apple 特化 Apple Notes |
|------------|----------------|-----------------------|
| Auth & Identity | Email/密碼登入、JWT、角色（learner/mentor/researcher）、多因素驗證 | 使用 Sign in with Apple 作為可選 MDM 流程；Keychain 儲存 token |
| Catalog & Metadata | 聯邦搜尋（公立圖書館、族語語料庫）、ISBN 掃描、閱讀上下文擷取 | iPad/iPhone 使用 VisionKit 條碼掃描，Mac 版提供拖放檔案；支援離線快取 |
| Recommendation | 內容式 + 協同過濾 + CARE 文化標籤；情緒／學習目標調適 | 在裝置端運算快速 re-ranking（Core ML lightweight 模型）；watchOS 顯示短篇推薦 |
| Session Orchestration | 閱讀流程、任務卡、學習成效紀錄 | Apple Watch live activity 追蹤朗讀節奏；iPad 拆分視窗顯示 AR 注釋 |
| Emotion Sensing | 語音 prosody、臉部表情（Vision）、Apple Watch 生理訊號（需特別授權） | 先以 on-device 估計；如需上傳影像/音訊須取得 CARE 委員會許可 |
| Multisensory Output | 表情語音、Core Haptics、Apple Watch Taptic Engine、背景聲音 | 現階段以 Apple 原生感官為主；嗅覺介面預留擴充介面 |
| CARE Governance | 資料治理流程、社群儀表板、審核軌跡 | Mac 端提供 CARE 專用儀表板，支援匯出審計報告 |

## 4. Apple 裝置體驗設計 Device-specific Experiences
- **iPad (主教學裝置)**
  - ARKit + RealityKit 疊加族語詞彙、場景重建。
  - 分割畫面：左側實體書掃描／翻譯，右側 AI 伴讀對話。
  - Apple Pencil 支援筆記、重點標記，並同步到雲端。
- **iPhone (流動學習)**
  - Quick Start 模式：短篇閱讀任務、Daily Phrase；支援背景聆聽。
  - Live Activities 顯示進度、情緒快訊。
- **MacBook Air (研究與行政)**
  - Catalyst 介面整合 CARE 儀表板、語料標註工具、研究報表。
  - 支援拖放上傳族語音訊，觸發後端轉寫與增強流程。
- **Apple Watch (伴讀穿戴)**
  - WatchKit 小工具顯示最新推薦與情緒提示。
  - Core Haptics 引導朗讀節奏；Complication 呈現語言練習「今日任務」。

## 5. 技術元件 Technical Stack Deep Dive
### 5.1 Backend (FastAPI) — *原型進行中*
- Auth：JWT + python-jose；下一步整合 Sign in with Apple。
- Database：PostgreSQL/SQLite（現為 SQLite 原型）+ SQLAlchemy + Alembic（待補 migrations）。
- Recommendation：Hybrid pipeline（語言、情緒、文化標記 → 已有初版）；RAG 與 LLM 整合列入下一階段。
- Emotion Event Stream：Kafka/Redpanda + workers（計畫中）。

### 5.2 Data & Model Pipeline — *待強化*
- Ingestion：`data/ingestion/` 預留對 SIL、ELAR 等 API 連接。
- Augmentation：`data/processing/augmentation.py` 為 NLLB/torchaudio 等增強腳本的骨架。
- LoRA 微調：預期使用 Hugging Face PEFT (LLaMA/Mistral) + Whisper；artifacts 置於 `data/models/`。
- 評估：自動（BLEU/chrF/WER）＋人評（族語顧問）；成果回寫 `ops/compliance`。

### 5.3 Apple Client Shared Code — *已建立 Swift Package*
- `ModernReaderServices`: REST API client、Auth store、資料模型。
- `ModernReaderUI`: SwiftUI 主介面（登入、推薦列表）。
- `ModernReaderWatch`: WatchKit 模型支援情緒摘要。
- 實際 App Target 需在 Xcode 另建專案並導入此 Package；設定 `API_BASE_URL`、App Groups、Keychain。

## 6. CARE 與資料治理 CARE & Data Governance
- 原住民族諮詢委員會與 CARE Checklist (`ops/compliance/CARE_CHECKLIST.md`)；需常態更新。
- 資料主權控制：
  - API 請求帶 `X-CARE-Consent-ID`（待實作）。
  - 日誌採結構化 JSON、敏感欄位加密並遵守 30 天保留（`CARE_DATA_RETENTION_DAYS`）。
- 原始影像/音訊可選擇僅保留特徵向量，需社群授權。

## 7. 測試與品質保障 Testing & QA
- Backend：pytest + httpx（待新增），目前先以手動驗證為主。
- Web：Vite + React；下一步導入 Vitest / Playwright。
- Apple：XCTest、ViewInspector、SnapshotTesting（需新增）。
- 人因與安全：情感偵測準確率、學習成效量測、OWASP Mobile Top 10 自評。

## 8. 實作路線圖 Roadmap (12 個月)
1. **M1-M2**：重建 repo、確定 CARE 協議、完成 FastAPI 基礎與 SwiftUI 原型。✅ Backend prototype 已完成第一輪。
2. **M3-M4**：語料蒐集與資料增強 PoC、實作 Apple 登入與基本推書。➡️ 目前進行中（資料管線骨架已設）。
3. **M5-M6**：ARKit 整合、情感偵測 Pipeline（Vision + Core ML + Kafka）。
4. **M7-M8**：LoRA 微調完成、少數語言模型部署、Apple Watch 伴讀體驗。
5. **M9-M10**：使用者研究、A/B 測試推薦策略、CARE 儀表板。
6. **M11-M12**：田野試驗、社群回饋整合、論文／報告撰寫、成果工作坊。

## 9. 調整與取捨 Additions & Trade-offs
- **新增**：永續化資料層、Metasearch、混合推薦、Session Telemetry、Web Catalog UI。
- **保留**：LoRA 模型策略、CARE 治理流程、Apple 全端願景。
- **暫緩**：嗅覺裝置整合、外部觸覺硬體；待 Apple 生態功能完善後再對接。
- **技術債**：
  - 建立 Alembic migrations、pytest 覆蓋率。
  - RAG + LLM + STT/TTS 真實整合仍待完成。

## 10. 下一步行動 Immediate Next Steps
1. 擴充資料蒐集腳本並啟用向量索引 + RAG 迴路。
2. 接上 STT/TTS（Whisper + Expressive TTS）與情緒感測實作。
3. 完成 CARE 同意流程、審計儀表板與 API header 實作。
4. 在 Xcode 建立多平台 App target，演示與後端互動、情境化 UI。
5. 規劃使用者研究與 TestFlight 內測，回蒐情緒體驗與文化適切性。
